<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ThreadLocal之应用篇 | Just For Fun</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="我们知道多线程环境下，每一个线程均可以使用所属进程的全局变量。如果一个线程对全局变量进行了修改，将会影响到其他所有的线程。为了避免多个线程同时对变量进行修改，引入了线程同步机制，通过互斥锁，条件变量或者读写锁来控制对全局变量的访问。
只用全局变量并不能满足多线程环境的需求，很多时候线程还需要拥有自己的私有数据，这些数据对于其他线程来说不可见。因此线程中也可以使用局部变量，局部变量只有线程自身可以访">
<meta property="og:type" content="article">
<meta property="og:title" content="ThreadLocal之应用篇">
<meta property="og:url" content="http://selfboot.cn/2016/08/22/threadlocal_overview/index.html">
<meta property="og:site_name" content="Just For Fun">
<meta property="og:description" content="我们知道多线程环境下，每一个线程均可以使用所属进程的全局变量。如果一个线程对全局变量进行了修改，将会影响到其他所有的线程。为了避免多个线程同时对变量进行修改，引入了线程同步机制，通过互斥锁，条件变量或者读写锁来控制对全局变量的访问。
只用全局变量并不能满足多线程环境的需求，很多时候线程还需要拥有自己的私有数据，这些数据对于其他线程来说不可见。因此线程中也可以使用局部变量，局部变量只有线程自身可以访">
<meta property="og:image" content="http://xuelangzf-github.qiniudn.com/20160822_threadlocal_overview_1.png">
<meta property="og:image" content="http://xuelangzf-github.qiniudn.com/20160822_threadlocal_overview_2.png">
<meta property="og:updated_time" content="2016-08-22T09:54:02.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ThreadLocal之应用篇">
<meta name="twitter:description" content="我们知道多线程环境下，每一个线程均可以使用所属进程的全局变量。如果一个线程对全局变量进行了修改，将会影响到其他所有的线程。为了避免多个线程同时对变量进行修改，引入了线程同步机制，通过互斥锁，条件变量或者读写锁来控制对全局变量的访问。
只用全局变量并不能满足多线程环境的需求，很多时候线程还需要拥有自己的私有数据，这些数据对于其他线程来说不可见。因此线程中也可以使用局部变量，局部变量只有线程自身可以访">
<meta name="twitter:image" content="http://xuelangzf-github.qiniudn.com/20160822_threadlocal_overview_1.png">
  
    <link rel="alternative" href="/atom.xml" title="Just For Fun" type="application/atom+xml">
  
  
    <link rel="icon" href="/image/favicon.ico">
  
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link href="//libs.useso.com/js/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-41784041-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
<!-- Baidu Analytics -->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?fd3ab4b3c488cbb43afa1c2669f06648";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!-- End Baidu Analytics -->


</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Just For Fun</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">享受快乐的时光</a>
        </h2>
      
    </div>
    <div id="header-menu">
      <nav id="main-nav">
        <ul>
        
          <li><a href="/"><i class="fa fa-home icon-setting"></i></a></li>
        
          <li><a href="/archives"><i class="fa fa-archive icon-setting"></i></a></li>
        
          <li><a href="/aboutme.html"><i class="fa fa-user icon-setting"></i></a></li>
        
        
          <li><a href="/atom.xml"><i class="fa fa-rss %> icon-setting"></i></a></li>
        
        </ul>
      </nav>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-threadlocal_overview" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/22/threadlocal_overview/" class="article-date">
  <time datetime="2016-08-22T14:02:50.000Z" itemprop="datePublished">8月 22 2016</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/程序设计/">程序设计</a>
  </div>

  </div>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ThreadLocal之应用篇
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>我们知道多线程环境下，每一个线程均可以使用所属进程的全局变量。如果一个线程对全局变量进行了修改，将会影响到其他所有的线程。为了避免多个线程同时对变量进行修改，引入了线程同步机制，通过互斥锁，条件变量或者读写锁来控制对全局变量的访问。</p>
<p>只用全局变量并不能满足多线程环境的需求，很多时候线程还需要拥有自己的私有数据，这些数据对于其他线程来说不可见。因此线程中也可以使用局部变量，局部变量只有线程自身可以访问，同一个进程下的其他线程不可访问。</p>
<p>有时候使用局部变量不太方便，因此 python 还提供了 ThreadLocal 变量，它本身是一个全局变量，但是每个线程却可以利用它来保存属于自己的私有数据，这些私有数据对其他线程也是不可见的。下图给出了线程中这几种变量的存在情况：</p>
<p><img src="http://xuelangzf-github.qiniudn.com/20160822_threadlocal_overview_1.png" alt="线程变量"></p>
<a id="more"></a>
<h1 id="全局-VS-局部变量"><a href="#全局-VS-局部变量" class="headerlink" title="全局 VS 局部变量"></a>全局 VS 局部变量</h1><p>首先借助一个小程序来看看多线程环境下全局变量的同步问题。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line">global_num = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread_cal</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> global_num</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1000</span>):</div><div class="line">        global_num += <span class="number">1</span></div><div class="line"></div><div class="line"><span class="comment"># Get 10 threads, run them and wait them all finished.</span></div><div class="line">threads = []</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    threads.append(threading.Thread(target=thread_cal))</div><div class="line">    threads[i].start()</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    threads[i].join()</div><div class="line"></div><div class="line"><span class="comment"># Value of global variable can be confused.</span></div><div class="line"><span class="keyword">print</span> global_num</div></pre></td></tr></table></figure>
<p>这里我们创建了10个线程，每个线程均对全局变量 global_num 进行1000次的加1操作（循环1000次加1是为了延长单个线程执行时间，使线程执行时被中断切换），当10个线程执行完毕时，全局变量的值是多少呢？答案是不确定。简单来说是因为 <code>global_num += 1</code> 并不是一个原子操作，因此执行过程可能被其他线程中断，导致其他线程读到一个脏值。以两个线程执行 +1 为例，其中一个可能的执行序列如下（此情况下最后结果为1）：</p>
<p><img src="http://xuelangzf-github.qiniudn.com/20160822_threadlocal_overview_2.png" alt="多线程全局变量同步"></p>
<p>多线程中使用全局变量时普遍存在这个问题，解决办法也很简单，可以使用互斥锁、条件变量或者是读写锁。下面考虑用互斥锁来解决上面代码的问题，只需要在进行 +1 运算前加锁，运算完毕释放锁即可，这样就可以保证运算的原子性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">l = threading.Lock()</div><div class="line">...</div><div class="line">    l.acquire()</div><div class="line">    global_num += <span class="number">1</span></div><div class="line">    l.release()</div></pre></td></tr></table></figure>
<p>在线程中使用局部变量则不存在这个问题，因为每个线程的局部变量不能被其他线程访问。下面我们用10个线程分别对各自的局部变量进行1000次加1操作，每个线程结束时打印一共执行的操作次数（每个线程均为1000）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(num)</span>:</span></div><div class="line">    <span class="keyword">print</span> threading.current_thread().getName(), num</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread_cal</span><span class="params">()</span>:</span></div><div class="line">    local_num = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(<span class="number">1000</span>):</div><div class="line">        local_num += <span class="number">1</span></div><div class="line">    show(local_num)</div><div class="line"></div><div class="line">threads = []</div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    threads.append(threading.Thread(target=thread_cal))</div><div class="line">    threads[i].start()</div></pre></td></tr></table></figure>
<p>可以看出这里每个线程都有自己的 local_num，各个线程之间互不干涉。</p>
<h1 id="Thread-local-对象"><a href="#Thread-local-对象" class="headerlink" title="Thread-local 对象"></a>Thread-local 对象</h1><p>上面程序中我们需要给 show 函数传递 local_num 局部变量，并没有什么不妥。不过考虑在实际生产环境中，我们可能会调用很多函数，每个函数都需要很多局部变量，这时候用传递参数的方法会很不友好。</p>
<p>为了解决这个问题，一个直观的的方法就是建立一个全局字典，保存进程 ID 到该进程局部变量的映射关系，运行中的线程可以根据自己的 ID 来获取本身拥有的数据。这样，就可以避免在函数调用中传递参数，如下示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">global_data = &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></div><div class="line">    cur_thread = threading.current_thread()</div><div class="line">    <span class="keyword">print</span> cur_thread.getName(), global_data[cur_thread]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread_cal</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> global_data</div><div class="line">    cur_thread = threading.current_thread()</div><div class="line">    global_data[cur_thread] = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(<span class="number">1000</span>):</div><div class="line">        global_data[cur_thread] += <span class="number">1</span></div><div class="line">    show()  <span class="comment"># Need no local variable.  Looks good.</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>保存一个全局字典，然后将线程标识符作为key，相应线程的局部数据作为 value，这种做法并不完美。首先，每个函数在需要线程局部数据时，都需要先取得自己的线程ID，略显繁琐。更糟糕的是，这里并没有真正做到线程之间数据的隔离，因为每个线程都可以读取到全局的字典，每个线程都可以对字典内容进行更改。</p>
<p>为了更好解决这个问题，python 线程库实现了 ThreadLocal 变量（很多语言都有类似的实现，比如Java）。ThreadLocal 真正做到了线程之间的数据隔离，并且使用时不需要手动获取自己的线程 ID，如下示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">global_data = threading.local()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> threading.current_thread().getName(), global_data.num</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">thread_cal</span><span class="params">()</span>:</span></div><div class="line">    global_data.num = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(<span class="number">1000</span>):</div><div class="line">        global_data.num += <span class="number">1</span></div><div class="line">    show()</div><div class="line"></div><div class="line">threads = []</div><div class="line">...</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"Main thread: "</span>, global_data.__dict__ <span class="comment"># &#123;&#125;</span></div></pre></td></tr></table></figure>
<p>上面示例中每个线程都可以通过 global_data.num 获得自己独有的数据，并且每个线程读取到的 global_data 都不同，真正做到线程之间的隔离。</p>
<p>ThreadLocal 实现的代码量不多，但是比较难理解，涉及很多 Python 黑魔法，下篇再来分析。那么 ThreadLocal 很完美了？不！Python 的 WSGI 工具库 werkzeug 中有一个更好的 <a href="https://github.com/pallets/werkzeug/blob/8a84b62b3dd89fe7d720d7948954e20ada690c40/werkzeug/local.py" target="_blank" rel="external">ThreadLocal 实现</a>，甚至支持协程之间的私有数据，实现更加复杂，有机会再分析。</p>
<h1 id="更多阅读"><a href="#更多阅读" class="headerlink" title="更多阅读"></a>更多阅读</h1><p><a href="http://stackoverflow.com/questions/1408171/thread-local-storage-in-python" target="_blank" rel="external">Thread local storage in Python</a><br><a href="https://pymotw.com/2/threading/" target="_blank" rel="external">threading – Manage concurrent threads</a><br><a href="https://harveyqing.gitbooks.io/python-read-and-write/content/python_advance/python_thread_sync.html" target="_blank" rel="external">Python线程同步机制</a><br><a href="http://www.cnblogs.com/vamei/archive/2012/10/09/2715393.html" target="_blank" rel="external">Linux多线程与同步</a><br><a href="https://www.quora.com/Are-local-variables-in-a-python-function-thread-safe" target="_blank" rel="external">Are local variables in a python function thread safe?</a>  </p>

      
    </div>

    
	    <!-- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
		   欣赏此文？支持一下吧
        </span>
        <br>
      </div>  
	<div id="donate_guide" class="donate_bar center hidden" >
		<!-- 支付宝打赏图案 -->
		<img src="http://xuelangzf-github.qiniudn.com/zhifubao.jpg" alt="支付宝打赏"> 
		<!-- 微信打赏图案 -->
		<img src="http://xuelangzf-github.qiniudn.com/weixin.jpg" alt="微信打赏">  
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</div>
<!-- 添加捐赠图标 -->

    
  
    
	    <div class="article-footer-copyright">

<p>本文由 selfboot 发表于 <a href="http://selfboot.cn" target="_blank">个人博客</a>，采用<a href="http://creativecommons.org/licenses/by-sa/3.0/cn" target="_blank" >署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>。</p>
<p>非商业转载请注明作者及出处。商业转载请联系<a href="mailto:xuezaigds@gmail.com">作者</a>本人。</p>
<p>
本文标题为: ThreadLocal之应用篇<br/>
本文链接为: <a href="/2016/08/22/threadlocal_overview/" target="_blank">http://selfboot.cn/2016/08/22/threadlocal_overview/</a>
</p>
</div>

    

    <footer class="article-footer">
      
        <a href="http://selfboot.cn/2016/08/22/threadlocal_overview/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/思考/">思考</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/08/07/forum_design_wsgi/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">从零开始搭建论坛（二）：Web服务器网关接口</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>



  <!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57adc438b914651b"></script>



</section>
      </div>
    </div>
    
    
<script>
  var disqus_shortname = 'xuelangZF';
  
  var disqus_url = 'http://selfboot.cn/2016/08/22/threadlocal_overview/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }());
</script>


<script src="http://libs.useso.com/js/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/script.js"></script>

  </div>
</body>
</html>
